name: AI Code Analysis
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install OpenAI
        run: pip install openai
      
      - name: Run AI Code Analysis
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "ü§ñ Starting AI code analysis..."
          
          # Simple analysis script
          cat > analyze.py << 'EOF'
          import os
          import subprocess
          
          # Check what files exist
          print("üìÅ Checking repository structure...")
          result = subprocess.run(["find", ".", "-type", "f", "-name", "*.js", "-o", "-name", "*.ts", "-o", "-name", "*.py", "-o", "-name", "*.json", "-o", "-name", "*.md"], 
                                 capture_output=True, text=True)
          files = result.stdout.strip().split('\n')
          
          # Filter out node_modules and .git
          filtered_files = [f for f in files if f and not any(x in f for x in ['node_modules', '.git'])]
          
          print(f"Found {len(filtered_files)} files")
          
          # Create simple report
          with open("AI_REPORT.md", "w") as f:
              f.write("# ü§ñ AI Code Analysis Report\n\n")
              f.write(f"**Repository:** SolarPunk-Autonomous\n")
              f.write(f"**Files analyzed:** {len(filtered_files)}\n\n")
              
              if filtered_files:
                  f.write("## File Structure:\n")
                  for file in filtered_files[:20]:  # First 20 files
                      f.write(f"- `{file}`\n")
                  
                  if len(filtered_files) > 20:
                      f.write(f"\n... and {len(filtered_files) - 20} more files\n")
              
              f.write("\n## Next Steps:\n")
              f.write("1. Review the file structure above\n")
              f.write("2. AI will analyze code in next workflow run\n")
              f.write("3. Fixes will be suggested automatically\n")
          
          print("‚úÖ Report generated: AI_REPORT.md")
          EOF
          
          python analyze.py
      
      - name: Upload AI Report
        uses: actions/upload-artifact@v4
        with:
          name: ai-analysis-report
          path: AI_REPORT.md
      
      - name: Display Report Summary
        run: |
          if [ -f "AI_REPORT.md" ]; then
            echo "üìä REPORT SUMMARY:"
            head -20 AI_REPORT.md
          else
            echo "‚ùå No report generated"
          fi
